// ignore_for_file: deprecated_member_use

import 'package:flutter/material.dart';
import 'package:cached_network_image/cached_network_image.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:intl/intl.dart';
import 'package:provider/provider.dart';
import '../../core/utils/localization_helper.dart';
import '../../core/utils/date_formatter.dart';
import '../../providers/news_provider.dart';
import '../../providers/audio_player_provider.dart';
import '../../providers/remote_config_provider.dart';
import '../../data/models/news_article.dart';

/// Categories tab - Shows breaking news in carousel design when opened (exact design match)
class CategoriesTab extends StatefulWidget {
  const CategoriesTab({super.key});

  @override
  State<CategoriesTab> createState() => _CategoriesTabState();
}

class _CategoriesTabState extends State<CategoriesTab>
    with AutomaticKeepAliveClientMixin, WidgetsBindingObserver {
  late PageController _pageController;
  List<NewsArticle> _articlesList = [];
  int _currentPageIndex = 0;
  NewsArticle? _lastPlayedArticle;
  bool _isSwiping = false;
  bool _isAutoAdvanceAnimating =
      false; // Flag to prevent stopping audio during auto-advance
  DateTime _selectedDate = DateTime.now();
  bool _hasInitialized = false;

  @override
  void initState() {
    super.initState();
    WidgetsBinding.instance.addObserver(this);
    _pageController = PageController(
      viewportFraction: 0.85, // Show partial adjacent cards (carousel effect)
    );

    // Initialize breaking news when tab opens
    WidgetsBinding.instance.addPostFrameCallback((_) {
      if (mounted && !_hasInitialized) {
        _initializeBreakingNews();
      }
    });
  }

  /// Initialize breaking news when tab opens
  void _initializeBreakingNews() {
    final newsProvider = context.read<NewsProvider>();

    // Mark as initialized
    setState(() {
      _hasInitialized = true;
    });

    // Update articles list based on whether a date is selected
    List<NewsArticle> sourceArticles;
    if (newsProvider.selectedDate != null) {
      // If a date is selected, use todayNews (which contains date-filtered news)
      sourceArticles = newsProvider.todayNews;
      debugPrint(
          'ðŸ“° Categories tab: Using date-filtered news (${sourceArticles.length} articles)');
    } else {
      // Otherwise, use breaking news
      sourceArticles = newsProvider.breakingNews;
      debugPrint(
          'ðŸ“° Categories tab: Using breaking news (${sourceArticles.length} articles)');
    }

    if (sourceArticles.isNotEmpty) {
      setState(() {
        _articlesList = sourceArticles;
        _currentPageIndex = 0;
        _lastPlayedArticle = null;
        debugPrint(
          'ðŸ“° Categories tab: Initialized with ${_articlesList.length} articles',
        );
      });

      // Reset to first page after build
      WidgetsBinding.instance.addPostFrameCallback((_) {
        if (mounted && _pageController.hasClients && _articlesList.isNotEmpty) {
          _pageController.jumpToPage(0);
        }
      });
    }

    // Always fetch appropriate news when tab opens
    if (!newsProvider.isLoading) {
      if (newsProvider.selectedDate != null) {
        // Fetch news for selected date
        newsProvider.fetchNewsByDate(newsProvider.selectedDate!, limit: 10);
        debugPrint('ðŸ“° Categories tab: Fetching news for selected date...');
      } else {
        // Fetch breaking news
        newsProvider.fetchBreakingNews(limit: 10);
        debugPrint('ðŸ“° Categories tab: Fetching breaking news...');
      }
    } else {
      debugPrint('ðŸ“° Categories tab: News is already loading...');
    }
  }

  @override
  void dispose() {
    WidgetsBinding.instance.removeObserver(this);
    _pageController.dispose();
    // Stop audio when leaving the tab
    final audioProvider = context.read<AudioPlayerProvider>();
    if (audioProvider.isPlaying || audioProvider.isPaused) {
      audioProvider.stop();
    }
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    super.build(context);
    final theme = Theme.of(context);
    final newsProvider = Provider.of<NewsProvider>(context);

    // Update articles list from appropriate source when it's loaded (listen to provider changes)
    if (_hasInitialized) {
      // Determine which source to use based on date selection
      List<NewsArticle> sourceArticles;
      if (newsProvider.selectedDate != null) {
        // If a date is selected, use todayNews (date-filtered news)
        sourceArticles = newsProvider.todayNews;
      } else {
        // Otherwise, use breaking news
        sourceArticles = newsProvider.breakingNews;
      }

      // Update when source articles are available
      if (sourceArticles.isNotEmpty) {
        if (_articlesList != sourceArticles || _articlesList.isEmpty) {
          WidgetsBinding.instance.addPostFrameCallback((_) {
            if (mounted) {
              setState(() {
                final previousLength = _articlesList.length;
                _articlesList = sourceArticles;
                // Ensure current page index is valid
                if (_currentPageIndex >= _articlesList.length) {
                  _currentPageIndex = 0;
                  _lastPlayedArticle = null;
                }
                // Reset to first page if articles were just loaded
                if (_articlesList.isNotEmpty) {
                  if (previousLength == 0 && _pageController.hasClients) {
                    // First time loading, jump to page 0
                    _pageController.jumpToPage(0);
                  } else if (_pageController.hasClients &&
                      _currentPageIndex < _articlesList.length) {
                    // Update existing position
                    _pageController.jumpToPage(_currentPageIndex);
                  }
                }
                debugPrint(
                  'ðŸ“° Categories tab: Updated with ${_articlesList.length} articles',
                );
              });
            }
          });
        }
      } else if (!newsProvider.isLoading && _articlesList.isNotEmpty) {
        // Source articles were cleared while we have articles, clear our list
        WidgetsBinding.instance.addPostFrameCallback((_) {
          if (mounted) {
            setState(() {
              _articlesList = [];
              _currentPageIndex = 0;
              _lastPlayedArticle = null;
              debugPrint(
                'ðŸ“° Categories tab: Source articles cleared, resetting articles list',
              );
            });
          }
        });
      }
    }

    return Scaffold(
      backgroundColor: theme.scaffoldBackgroundColor,
      body: Consumer<RemoteConfigProvider>(
        builder: (context, configProvider, child) {
          final config = configProvider.config;
          return Column(
            children: [
              _buildModernHeader(context, config),
              Expanded(child: _buildModernContent(theme, config, newsProvider)),
              Consumer<AudioPlayerProvider>(
                builder: (context, audioProvider, child) {
                  final articleToShow = _articlesList.isNotEmpty
                      ? _articlesList[_currentPageIndex]
                      : null;
                  // if (articleToShow != null) {
                  //   return _buildModernAudioPlayerBar(
                  //       articleToShow, config, theme, audioProvider);
                  // }
                  return const SizedBox.shrink();
                },
              ),
              SizedBox(height: MediaQuery.of(context).padding.bottom),
            ],
          );
        },
      ),
    );
  }

  @override
  bool get wantKeepAlive => true;

  /// Build modern header with responsive design
  Widget _buildModernHeader(BuildContext context, dynamic config) {
    return LayoutBuilder(
      builder: (context, constraints) {
        final isTablet = constraints.maxWidth > 600;
        final isLargeScreen = constraints.maxWidth > 900;

        return SafeArea(
          child: Padding(
            padding: EdgeInsets.symmetric(
              horizontal: isLargeScreen
                  ? 32
                  : isTablet
                      ? 24
                      : 16,
              vertical: isLargeScreen ? 20 : 16,
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // App branding
                Row(
                  children: [
                    Container(
                      padding: const EdgeInsets.all(12),
                      decoration: BoxDecoration(
                        color: config.primaryColorValue,
                        borderRadius: BorderRadius.circular(16),
                      ),
                      child: Icon(
                        Icons.article,
                        color: Colors.white,
                        size: isLargeScreen ? 28 : 24,
                      ),
                    ),
                    const SizedBox(width: 16),
                    Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          'NewsOn',
                          style: GoogleFonts.playfairDisplay(
                            color:
                                Theme.of(context).brightness == Brightness.dark
                                    ? Colors.white
                                    : Colors.black,
                            fontSize: isLargeScreen ? 32 : 28,
                            fontWeight: FontWeight.bold,
                            letterSpacing: -0.5,
                          ),
                        ),
                        Text(
                          'Your Daily News Source',
                          style: GoogleFonts.inter(
                            color:
                                Theme.of(context).brightness == Brightness.dark
                                    ? Colors.white70
                                    : Colors.black54,
                            fontSize: isLargeScreen ? 16 : 14,
                            fontWeight: FontWeight.w500,
                          ),
                        ),
                      ],
                    ),
                  ],
                ),

                // Date selector
                SizedBox(height: isLargeScreen ? 24 : 20),
                _buildModernDateSelector(
                    context,
                    config,
                    _articlesList.isNotEmpty
                        ? _articlesList[_currentPageIndex]
                        : null),
              ],
            ),
          ),
        );
      },
    );
  }

  /// Build modern date selector with enhanced design
  Widget _buildModernDateSelector(
    BuildContext context,
    dynamic config,
    NewsArticle? article,
  ) {
    // Use article's date if available, otherwise use selected date
    DateTime displayDate = _selectedDate;
    if (article != null &&
        article.pubDate != null &&
        article.pubDate!.isNotEmpty) {
      final parsedDate = DateFormatter.parseApiDate(article.pubDate);
      if (parsedDate != null) {
        displayDate = parsedDate;
      }
    }

    return GestureDetector(
      
      onTap: () async {
        // Show date picker when tapped
        final picked = await showDatePicker(
          context: context,
          initialDate: _selectedDate,
          firstDate: DateTime(2020),
          lastDate: DateTime.now(),
          initialDatePickerMode: DatePickerMode.day,
          helpText: 'Select Date',
          cancelText: 'Cancel',
          confirmText: 'Select',
          fieldLabelText: 'Date',
          fieldHintText: 'Month/Day/Year',
        );

        if (picked != null && picked != _selectedDate) {
          // Normalize the date to remove time components
          final normalizedDate =
              DateTime(picked.year, picked.month, picked.day);
          setState(() => _selectedDate = normalizedDate);

          // Fetch news for the selected date (this will populate todayNews which we can use for headlines)
          if (mounted) {
            debugPrint(
                'ðŸ“° Categories tab: Fetching news for date ${DateFormat('yyyy-MM-dd').format(normalizedDate)}');
            await context
                .read<NewsProvider>()
                .fetchNewsByDate(normalizedDate, limit: 10);
          }
        }
      },
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
        decoration: BoxDecoration(
          color: config.primaryColorValue.withOpacity(0.1),
          borderRadius: BorderRadius.circular(25),
          border: Border.all(
            color: config.primaryColorValue.withOpacity(0.3),
            width: 1,
          ),
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(
              Icons.calendar_today_outlined,
              color: config.primaryColorValue,
              size: 18,
            ),
            const SizedBox(width: 8),
            Text(
              DateFormat('MMM dd, yyyy').format(displayDate),
              style: GoogleFonts.inter(
                color: config.primaryColorValue,
                fontSize: 14,
                fontWeight: FontWeight.w600,
                letterSpacing: 0.3,
              ),
            ),
            const SizedBox(width: 8),
            Icon(
              Icons.keyboard_arrow_down,
              color: config.primaryColorValue,
              size: 20,
            ),
          ],
        ),
      ),
    );
  }

  /// Build modern content area with responsive design
  Widget _buildModernContent(
    ThemeData theme,
    dynamic config,
    NewsProvider newsProvider,
  ) {
    return LayoutBuilder(
      builder: (context, constraints) {
        final isTablet = constraints.maxWidth > 600;
        final isLargeScreen = constraints.maxWidth > 900;

        return Column(
          children: [
            // Headlines section
            _buildModernHeadlinesSection(
                context, config, isLargeScreen, isTablet),

            // Main content area
            Expanded(
              child: _buildLoadingOrContentState(theme, config, newsProvider),
            ),
          ],
        );
      },
    );
  }

  /// Build modern headlines section with enhanced typography
  Widget _buildModernHeadlinesSection(
    BuildContext context,
    dynamic config,
    bool isLargeScreen,
    bool isTablet,
  ) {
    return Container(
      width: double.infinity,
      padding: EdgeInsets.symmetric(
        horizontal: isLargeScreen ? 8 : 0,
        vertical: 12,
      ),
      decoration: BoxDecoration(
        border: Border(
          bottom: BorderSide(
            color: config.primaryColorValue.withOpacity(0.2),
            width: 2,
          ),
        ),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Main headline text
          Text(
            LocalizationHelper.headlines(context),
            style: GoogleFonts.inter(
              color: config.primaryColorValue,
              fontSize: isLargeScreen
                  ? 32
                  : isTablet
                      ? 28
                      : 24,
              fontWeight: FontWeight.w800,
              letterSpacing: -0.5,
              height: 1.1,
            ),
          ),

          // Subtitle or description
          SizedBox(height: 4),
          Text(
            'Breaking stories from around the world',
            style: GoogleFonts.inter(
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.white70
                  : Colors.black54,
              fontSize: isLargeScreen ? 16 : 14,
              fontWeight: FontWeight.w500,
              letterSpacing: 0.2,
            ),
          ),
        ],
      ),
    );
  }

  /// Build modern audio player bar with enhanced design
  Widget _buildModernAudioPlayerBar(
    NewsArticle article,
    dynamic config,
    ThemeData theme,
    AudioPlayerProvider audioProvider,
  ) {
    final isCurrentArticle = audioProvider.currentArticle != null &&
        (audioProvider.currentArticle!.articleId ??
                audioProvider.currentArticle!.title) ==
            (article.articleId ?? article.title);

    final isPlaying = isCurrentArticle && audioProvider.isPlaying;
    final isLoading = isCurrentArticle && audioProvider.isLoading;

    // Calculate progress
    final duration = audioProvider.duration;
    final position = audioProvider.position;
    final progress = duration.inMilliseconds > 0
        ? position.inMilliseconds / duration.inMilliseconds
        : 0.0;

    // Format time as MM:SS
    final positionText = audioProvider.formatDuration(position);
    final durationText = audioProvider.formatDuration(duration);

    return LayoutBuilder(
      builder: (context, constraints) {
        final isTablet = constraints.maxWidth > 600;
        final isLargeScreen = constraints.maxWidth > 900;

        return Container(
          margin: EdgeInsets.symmetric(
            horizontal: isLargeScreen
                ? 32
                : isTablet
                    ? 24
                    : 16,
            vertical: isLargeScreen ? 16 : 12,
          ),
          padding: EdgeInsets.symmetric(
            horizontal: isLargeScreen ? 24 : 20,
            vertical: isLargeScreen ? 16 : 14,
          ),
          decoration: BoxDecoration(
            color: config.primaryColorValue,
            borderRadius: BorderRadius.circular(isLargeScreen ? 20 : 16),
            boxShadow: [
              BoxShadow(
                color: config.primaryColorValue.withOpacity(0.3),
                blurRadius: 20,
                offset: const Offset(0, 8),
              ),
            ],
          ),
          child: Column(
            children: [
              // Article title and controls row
              Row(
                children: [
                  // Play/Pause button
                  GestureDetector(
                    onTap: () {
                      if (isCurrentArticle) {
                        if (isPlaying) {
                          audioProvider.pause();
                        } else {
                          audioProvider.resume();
                        }
                      } else {
                        // Start playing this article
                        audioProvider.playArticleFromUrl(article,
                            playTitle: true);
                      }
                    },
                    child: Container(
                      padding: const EdgeInsets.all(8),
                      decoration: BoxDecoration(
                        color: Colors.white.withOpacity(0.2),
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: isLoading
                          ? SizedBox(
                              width: 24,
                              height: 24,
                              child: CircularProgressIndicator(
                                strokeWidth: 2,
                                valueColor:
                                    AlwaysStoppedAnimation<Color>(Colors.white),
                              ),
                            )
                          : Icon(
                              isPlaying ? Icons.pause : Icons.play_arrow,
                              color: Colors.white,
                              size: 24,
                            ),
                    ),
                  ),

                  const SizedBox(width: 16),

                  // Article title
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          article.title,
                          style: GoogleFonts.inter(
                            color: Colors.white,
                            fontSize: isLargeScreen ? 16 : 14,
                            fontWeight: FontWeight.w600,
                          ),
                          maxLines: 1,
                          overflow: TextOverflow.ellipsis,
                        ),
                        if (article.sourceName?.isNotEmpty == true)
                          Text(
                            article.sourceName!,
                            style: GoogleFonts.inter(
                              color: Colors.white70,
                              fontSize: isLargeScreen ? 14 : 12,
                              fontWeight: FontWeight.w500,
                            ),
                            maxLines: 1,
                            overflow: TextOverflow.ellipsis,
                          ),
                      ],
                    ),
                  ),

                  // Speed control
                  GestureDetector(
                    onTap: () {
                      // Cycle through speeds: 0.5x, 0.75x, 1.0x, 1.25x, 1.5x, 2.0x
                      double currentSpeed = audioProvider.playbackSpeed;
                      double newSpeed;
                      if (currentSpeed <= 0.5) {
                        newSpeed = 0.75;
                      } else if (currentSpeed <= 0.75) {
                        newSpeed = 1.0;
                      } else if (currentSpeed <= 1.0) {
                        newSpeed = 1.25;
                      } else if (currentSpeed <= 1.25) {
                        newSpeed = 1.5;
                      } else if (currentSpeed <= 1.5) {
                        newSpeed = 2.0;
                      } else {
                        newSpeed = 0.5;
                      }
                      audioProvider.setPlaybackSpeed(newSpeed);
                    },
                    child: Container(
                      padding: const EdgeInsets.symmetric(
                          horizontal: 8, vertical: 4),
                      decoration: BoxDecoration(
                        color: Colors.white.withOpacity(0.2),
                        borderRadius: BorderRadius.circular(8),
                      ),
                      child: Text(
                        '${audioProvider.playbackSpeed}x',
                        style: GoogleFonts.inter(
                          color: Colors.white,
                          fontSize: isLargeScreen ? 12 : 10,
                          fontWeight: FontWeight.w600,
                        ),
                      ),
                    ),
                  ),
                ],
              ),

              const SizedBox(height: 12),

              // Progress bar
              Row(
                children: [
                  // Time
                  Text(
                    positionText,
                    style: GoogleFonts.inter(
                      color: Colors.white70,
                      fontSize: isLargeScreen ? 12 : 10,
                      fontWeight: FontWeight.w500,
                    ),
                  ),

                  const SizedBox(width: 12),

                  // Progress bar
                  Expanded(
                    child: Container(
                      height: 4,
                      decoration: BoxDecoration(
                        color: Colors.white.withOpacity(0.3),
                        borderRadius: BorderRadius.circular(2),
                      ),
                      child: FractionallySizedBox(
                        alignment: Alignment.centerLeft,
                        widthFactor: progress,
                        child: Container(
                          decoration: BoxDecoration(
                            color: Colors.white,
                            borderRadius: BorderRadius.circular(2),
                          ),
                        ),
                      ),
                    ),
                  ),

                  const SizedBox(width: 12),

                  // Duration
                  Text(
                    durationText,
                    style: GoogleFonts.inter(
                      color: Colors.white70,
                      fontSize: isLargeScreen ? 12 : 10,
                      fontWeight: FontWeight.w500,
                    ),
                  ),
                ],
              ),
            ],
          ),
        );
      },
    );
  }

  /// Build loading state
  Widget _buildLoadingState(ThemeData theme, dynamic config) {
    return Center(
      child: CircularProgressIndicator(color: config.primaryColorValue),
    );
  }

  /// Build no news state
  Widget _buildNoNewsState(ThemeData theme) {
    return Center(
      child: Text(
        LocalizationHelper.noNewsAvailable(context),
        style: theme.textTheme.bodyLarge?.copyWith(color: Colors.white70),
      ),
    );
  }

  /// Build loading or content state based on date selection
  Widget _buildLoadingOrContentState(
      ThemeData theme, dynamic config, NewsProvider newsProvider) {
    // Determine which source to check based on date selection
    List<NewsArticle> sourceArticles;
    if (newsProvider.selectedDate != null) {
      // If a date is selected, check todayNews
      sourceArticles = newsProvider.todayNews;
    } else {
      // Otherwise, check breaking news
      sourceArticles = newsProvider.breakingNews;
    }

    // Show loading if provider is loading and source is empty
    if (newsProvider.isLoading && sourceArticles.isEmpty) {
      return _buildLoadingState(theme, config);
    }

    // Show no news if source is empty and not loading
    if (sourceArticles.isEmpty) {
      return _buildNoNewsState(theme);
    }

    // Show no news if our articles list is empty
    if (_articlesList.isEmpty) {
      return _buildNoNewsState(theme);
    }

    // Show carousel
    return _buildCarousel(config, theme, newsProvider);
  }

  /// Build list view with ListView.builder (matching new UI design)
  Widget _buildCarousel(
    dynamic config,
    ThemeData theme,
    NewsProvider newsProvider,
  ) {
    return ListView.builder(
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
      itemCount: _articlesList.length,
      itemBuilder: (context, index) {
        final article = _articlesList[index];
        return _buildNewsListItem(article, config, theme, index);
      },
    );
  }

  /// Build a single news list item (matching new UI design)
  Widget _buildNewsListItem(
    NewsArticle article,
    dynamic config,
    ThemeData theme,
    int index,
  ) {
    return Consumer<AudioPlayerProvider>(
      builder: (context, audioProvider, child) {
        final isCurrentArticle = audioProvider.currentArticle != null &&
            (audioProvider.currentArticle!.articleId ??
                    audioProvider.currentArticle!.title) ==
                (article.articleId ?? article.title);
        final isPlaying = isCurrentArticle && audioProvider.isPlaying;
        final isLoading = isCurrentArticle && audioProvider.isLoading;

        return Container(
          margin: const EdgeInsets.only(bottom: 12),
          height: 100,
          decoration: BoxDecoration(
            color: Theme.of(context).brightness == Brightness.dark
                ? Colors.grey[900]
                : Colors.white,
            borderRadius: BorderRadius.circular(12),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.1),
                blurRadius: 8,
                offset: const Offset(0, 2),
              ),
            ],
          ),
          child: ClipRRect(
            borderRadius: BorderRadius.circular(12),
            child: Row(
              children: [
                // Left side - News image
                SizedBox(
                  width: 100,
                  height: 100,
                  child: CachedNetworkImage(
                    imageUrl: article.imageUrl ?? article.sourceIcon ?? '',
                    fit: BoxFit.cover,
                    errorWidget: (context, url, error) => Container(
                      color: Colors.grey[300],
                      child: const Icon(
                        Icons.image_not_supported,
                        color: Colors.grey,
                        size: 32,
                      ),
                    ),
                  ),
                ),

                // Middle - News content
                Expanded(
                  child: Padding(
                    padding: const EdgeInsets.all(12),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        // Category tag
                        Container(
                          padding: const EdgeInsets.symmetric(
                            horizontal: 6,
                            vertical: 2,
                          ),
                          decoration: BoxDecoration(
                            color: config.primaryColorValue.withOpacity(0.1),
                            borderRadius: BorderRadius.circular(4),
                          ),
                          child: Text(
                            LocalizationHelper.hotNews(context),
                            style: GoogleFonts.inter(
                              color: config.primaryColorValue,
                              fontSize: 10,
                              fontWeight: FontWeight.w600,
                            ),
                          ),
                        ),

                        const SizedBox(height: 4),

                        // News title
                        Text(
                          article.title,
                          style: GoogleFonts.inter(
                            color:
                                Theme.of(context).brightness == Brightness.dark
                                    ? Colors.white
                                    : Colors.black,
                            fontSize: 14,
                            fontWeight: FontWeight.w600,
                            height: 1.2,
                          ),
                          maxLines: 2,
                          overflow: TextOverflow.ellipsis,
                        ),

                        const SizedBox(height: 4),

                        // Source and time
                        Row(
                          children: [
                            if (article.sourceName?.isNotEmpty == true)
                              Text(
                                article.sourceName!,
                                style: GoogleFonts.inter(
                                  color: Theme.of(context).brightness ==
                                          Brightness.dark
                                      ? Colors.white70
                                      : Colors.black54,
                                  fontSize: 11,
                                  fontWeight: FontWeight.w500,
                                ),
                              ),
                            if (article.sourceName?.isNotEmpty == true &&
                                article.pubDate?.isNotEmpty == true)
                              Text(
                                ' â€¢ ',
                                style: GoogleFonts.inter(
                                  color: Theme.of(context).brightness ==
                                          Brightness.dark
                                      ? Colors.white70
                                      : Colors.black54,
                                  fontSize: 11,
                                ),
                              ),
                            if (article.pubDate?.isNotEmpty == true)
                              Text(
                                DateFormatter.getRelativeTime(
                                  DateFormatter.parseApiDate(
                                          article.pubDate!) ??
                                      DateTime.now(),
                                ),
                                style: GoogleFonts.inter(
                                  color: Theme.of(context).brightness ==
                                          Brightness.dark
                                      ? Colors.white70
                                      : Colors.black54,
                                  fontSize: 11,
                                  fontWeight: FontWeight.w500,
                                ),
                              ),
                          ],
                        ),
                      ],
                    ),
                  ),
                ),

                // Right side - Play button
                Padding(
                  padding: const EdgeInsets.only(right: 12),
                  child: GestureDetector(
                    onTap: () async {
                      if (isCurrentArticle) {
                        if (isPlaying) {
                          audioProvider.pause();
                        } else {
                          audioProvider.resume();
                        }
                      } else {
                        // Start playing this article
                        await _playArticle(article, audioProvider);
                      }
                    },
                    child: Container(
                      width: 40,
                      height: 40,
                      decoration: BoxDecoration(
                        color: config.primaryColorValue,
                        shape: BoxShape.circle,
                        boxShadow: [
                          BoxShadow(
                            color: config.primaryColorValue.withOpacity(0.3),
                            blurRadius: 8,
                            offset: const Offset(0, 2),
                          ),
                        ],
                      ),
                      child: Center(
                        child: isLoading
                            ? SizedBox(
                                width: 20,
                                height: 20,
                                child: CircularProgressIndicator(
                                  strokeWidth: 2,
                                  valueColor: AlwaysStoppedAnimation<Color>(
                                      Colors.white),
                                ),
                              )
                            : Icon(
                                isPlaying ? Icons.pause : Icons.play_arrow,
                                color: Colors.white,
                                size: 20,
                              ),
                      ),
                    ),
                  ),
                ),
              ],
            ),
          ),
        );
      },
    );
  }

  /// Play article with playlist setup (respects user's reading preference)
  Future<void> _playArticle(
    NewsArticle article,
    AudioPlayerProvider audioProvider,
  ) async {
    try {
      if (_articlesList.isEmpty) return;

      // Check if article is in our current articles list (breaking news)
      final articleIndex = _articlesList.indexWhere(
        (a) => (a.articleId ?? a.title) == (article.articleId ?? article.title),
      );

      if (articleIndex >= 0 && _articlesList.length > 1) {
        // Use current breaking news list as playlist
        // playTitle: true means use stored reading preference (title only / description only / full news)
        _lastPlayedArticle = article;
        await audioProvider.setPlaylistAndPlay(
          _articlesList,
          articleIndex,
          playTitle:
              true, // Use user's reading preference (AudioPlayerProvider handles it)
        );
        debugPrint(
          'ðŸŽµ Playing breaking news from categories tab: index $articleIndex/${_articlesList.length} (using reading preference)',
        );
      } else {
        // Single article or not in list
        // playTitle: true means use stored reading preference (title only / description only / full news)
        _lastPlayedArticle = article;
        await audioProvider.playArticleFromUrl(
          article,
          playTitle:
              true, // Use user's reading preference (AudioPlayerProvider handles it)
        );
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Failed to play audio: ${e.toString()}'),
            backgroundColor: Colors.red,
          ),
        );
      }
    }
  }
}
